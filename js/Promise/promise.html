<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>期约 | Sans_</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="stay hungry，stay foolish">
    
    <link rel="preload" href="/assets/css/0.styles.f81279c5.css" as="style"><link rel="preload" href="/assets/js/app.c68e1700.js" as="script"><link rel="preload" href="/assets/js/3.957d5f92.js" as="script"><link rel="preload" href="/assets/js/1.1e92a90c.js" as="script"><link rel="preload" href="/assets/js/34.29b25dcb.js" as="script"><link rel="prefetch" href="/assets/js/10.41b2bf91.js"><link rel="prefetch" href="/assets/js/11.eee2a19d.js"><link rel="prefetch" href="/assets/js/12.13154a0a.js"><link rel="prefetch" href="/assets/js/13.b9df14aa.js"><link rel="prefetch" href="/assets/js/14.4da73ee6.js"><link rel="prefetch" href="/assets/js/15.c603e9dc.js"><link rel="prefetch" href="/assets/js/16.7a8c63fb.js"><link rel="prefetch" href="/assets/js/17.16162e73.js"><link rel="prefetch" href="/assets/js/18.9bca3ebd.js"><link rel="prefetch" href="/assets/js/19.01ac5bc4.js"><link rel="prefetch" href="/assets/js/20.065b5032.js"><link rel="prefetch" href="/assets/js/21.b5bb0d31.js"><link rel="prefetch" href="/assets/js/22.04aa70df.js"><link rel="prefetch" href="/assets/js/23.1adba5e7.js"><link rel="prefetch" href="/assets/js/24.a507a6d1.js"><link rel="prefetch" href="/assets/js/25.6e52175e.js"><link rel="prefetch" href="/assets/js/26.18c3dc99.js"><link rel="prefetch" href="/assets/js/27.9aa6797e.js"><link rel="prefetch" href="/assets/js/28.d44ef097.js"><link rel="prefetch" href="/assets/js/29.cf89fe09.js"><link rel="prefetch" href="/assets/js/30.35a9b9d1.js"><link rel="prefetch" href="/assets/js/31.32d68f06.js"><link rel="prefetch" href="/assets/js/32.49593b8a.js"><link rel="prefetch" href="/assets/js/33.743ce33e.js"><link rel="prefetch" href="/assets/js/35.309181ea.js"><link rel="prefetch" href="/assets/js/36.24b74c86.js"><link rel="prefetch" href="/assets/js/37.e5a471e3.js"><link rel="prefetch" href="/assets/js/38.3f72950b.js"><link rel="prefetch" href="/assets/js/39.f03c4c47.js"><link rel="prefetch" href="/assets/js/4.0968ad41.js"><link rel="prefetch" href="/assets/js/40.cc9c0bb0.js"><link rel="prefetch" href="/assets/js/41.ebf9fe22.js"><link rel="prefetch" href="/assets/js/42.a37eaa07.js"><link rel="prefetch" href="/assets/js/5.ed348d91.js"><link rel="prefetch" href="/assets/js/6.cf81965e.js"><link rel="prefetch" href="/assets/js/7.97cb5f84.js"><link rel="prefetch" href="/assets/js/8.beddb4e4.js"><link rel="prefetch" href="/assets/js/9.54372a49.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f81279c5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-130b300a><div data-v-130b300a><div class="password-shadow password-wrapper-out" style="display:none;" data-v-25ba6db2 data-v-130b300a data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>Sans_</h3> <p class="description" data-v-25ba6db2 data-v-25ba6db2>stay hungry，stay foolish</p> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>sans</span>
            
          <!---->
          2022
        </a></span></div></div> <div class="hide" data-v-130b300a><header class="navbar" data-v-130b300a><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Sans_</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/CSS/" class="nav-link"><i class="undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/categories/笔记/" class="nav-link"><i class="undefined"></i>
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li><li class="dropdown-item"><!----> <a href="/categories/日常/" class="nav-link"><i class="undefined"></i>
  日常
</a></li><li class="dropdown-item"><!----> <a href="/categories/工具/" class="nav-link"><i class="undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/categories/数组/" class="nav-link"><i class="undefined"></i>
  数组
</a></li><li class="dropdown-item"><!----> <a href="/categories/服务器/" class="nav-link"><i class="undefined"></i>
  服务器
</a></li><li class="dropdown-item"><!----> <a href="/categories/心得/" class="nav-link"><i class="undefined"></i>
  心得
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/experience/utils.html" class="nav-link"><i class="undefined"></i>
  心得
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/js/" class="nav-link router-link-active"><i class="undefined"></i>
  JS
</a></li><li class="dropdown-item"><!----> <a href="/html/" class="nav-link"><i class="undefined"></i>
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link"><i class="undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/vue/experience/keepAlive.html" class="nav-link"><i class="undefined"></i>
  Vue
</a></li></ul></div></div><div class="nav-item"><a href="/js/about.html" class="nav-link"><i class="undefined"></i>
  关于
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-130b300a></div> <aside class="sidebar" data-v-130b300a><div class="personal-info-wrapper" data-v-39576ba9 data-v-130b300a><!----> <h3 class="name" data-v-39576ba9>
    sans
  </h3> <div class="num" data-v-39576ba9><div data-v-39576ba9><h3 data-v-39576ba9>29</h3> <h6 data-v-39576ba9>Articles</h6></div> <div data-v-39576ba9><h3 data-v-39576ba9>14</h3> <h6 data-v-39576ba9>Tags</h6></div></div> <ul class="social-links" data-v-39576ba9></ul> <hr data-v-39576ba9></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="undefined"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      Category
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/CSS/" class="nav-link"><i class="undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/categories/笔记/" class="nav-link"><i class="undefined"></i>
  笔记
</a></li><li class="dropdown-item"><!----> <a href="/categories/面试/" class="nav-link"><i class="undefined"></i>
  面试
</a></li><li class="dropdown-item"><!----> <a href="/categories/日常/" class="nav-link"><i class="undefined"></i>
  日常
</a></li><li class="dropdown-item"><!----> <a href="/categories/工具/" class="nav-link"><i class="undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/categories/数组/" class="nav-link"><i class="undefined"></i>
  数组
</a></li><li class="dropdown-item"><!----> <a href="/categories/服务器/" class="nav-link"><i class="undefined"></i>
  服务器
</a></li><li class="dropdown-item"><!----> <a href="/categories/心得/" class="nav-link"><i class="undefined"></i>
  心得
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/experience/utils.html" class="nav-link"><i class="undefined"></i>
  心得
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/js/" class="nav-link router-link-active"><i class="undefined"></i>
  JS
</a></li><li class="dropdown-item"><!----> <a href="/html/" class="nav-link"><i class="undefined"></i>
  HTML
</a></li><li class="dropdown-item"><!----> <a href="/css/" class="nav-link"><i class="undefined"></i>
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/vue/experience/keepAlive.html" class="nav-link"><i class="undefined"></i>
  Vue
</a></li></ul></div></div><div class="nav-item"><a href="/js/about.html" class="nav-link"><i class="undefined"></i>
  关于
</a></div> <!----></nav> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>对象</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>函数</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>期约与异步函数</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/js/Promise/" aria-current="page" class="sidebar-link">/js/Promise/</a></li><li><a href="/js/Promise/promise.html" aria-current="page" class="active sidebar-link">期约</a></li><li><a href="/js/Promise/asyncAwait.html" class="sidebar-link">异步函数(async/await)</a></li></ul></section></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-25ba6db2 data-v-130b300a><h3 class="title" data-v-25ba6db2 data-v-25ba6db2>期约</h3> <!----> <label id="box" class="inputBox" data-v-25ba6db2 data-v-25ba6db2><input type="password" value="" data-v-25ba6db2> <span data-v-25ba6db2>Konck! Knock!</span> <button data-v-25ba6db2>OK</button></label> <div class="footer" data-v-25ba6db2 data-v-25ba6db2><span data-v-25ba6db2><i class="iconfont reco-theme" data-v-25ba6db2></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-25ba6db2>vuePress-theme-reco</a></span> <span data-v-25ba6db2><i class="iconfont reco-copyright" data-v-25ba6db2></i> <a data-v-25ba6db2><span data-v-25ba6db2>sans</span>
            
          <!---->
          2022
        </a></span></div></div> <div data-v-130b300a><main class="page"><section><div class="page-title"><h1 class="title">期约</h1> <div data-v-f875f3fc><i class="iconfont reco-account" data-v-f875f3fc><span data-v-f875f3fc>sans</span></i> <i class="iconfont reco-date" data-v-f875f3fc><span data-v-f875f3fc>5/31/2021</span></i> <i class="iconfont reco-eye" data-v-f875f3fc><span id="/js/Promise/promise.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-f875f3fc><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-f875f3fc><span class="tag-item" data-v-f875f3fc>js</span><span class="tag-item" data-v-f875f3fc>promise</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="期约-promise"><a href="#期约-promise" class="header-anchor">#</a> 期约 (promise)</h2> <p>p325</p> <p><mark>期约是对尚不存在的一个结果的替身。</mark></p> <h2 id="_1、promise-a-规范"><a href="#_1、promise-a-规范" class="header-anchor">#</a> 1、<code>Promise/A+</code>规范</h2> <p>早期的期约机制是在<code>jQuery</code>和<code>Dojo</code>中以<code>Deferred API</code>的形式出现的。</p> <p>2010年<code>commonJS</code>项目实现的<code>Promise/A</code>规范才日益流行。</p> <p>2012年<code>Promise/A+</code>组织分叉（<code>fork</code>）了<code>commonJS</code>的<code>Promise/A</code>建议，并制定了同名的<code>Promise/A+</code>规范，该规范成为了<code>ES6</code>规范实现的范本。</p> <p><code>ES6</code>新增了<code>Promise</code>类型，所有现代浏览器都支持<code>ES6</code>期约，很多浏览器的<code>API</code>（如<code>fetch()和Battery Status API</code>）也是以期约为基础</p> <h2 id="_2、期约基础"><a href="#_2、期约基础" class="header-anchor">#</a> 2、期约基础</h2> <p><code>ES6</code>新增了引用类型<code>Promise</code>，通过<code>new</code>操作符进行实例化。创建新期约时需要传入一个执行器<code>（executor）</code>函数作为参数。并且其参数不能为空，</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// Promise{&lt;pending&gt;}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// let p1 = new Promise();</span>
<span class="token comment">// Promise resolver undefined is not a function</span>
<span class="token comment">// setTimeout(console.log, 0, p1);</span>
</code></pre></div><h3 id="_2-1、期约状态机"><a href="#_2-1、期约状态机" class="header-anchor">#</a> 2.1、期约状态机</h3> <p><mark>期约是一个有状态的对象，分为以下3种状态：</mark></p> <ul><li><p>待定（<code>pending</code>）;</p></li> <li><p>兑现（<code>fulfilled</code>，有时也被称为解决，<code>resolved</code>）；</p></li> <li><p>拒绝（<code>rejected</code>）</p></li></ul> <p><strong>待定（ <code>pending</code> ）</strong> 是期约的初始状态。在待定状态下，期约可以<strong>落定</strong>（<code>settled</code>）为代表成功的<strong>兑现</strong>（<code>fulfiled</code>）状态，或者代表失败的<strong>拒绝</strong>（<code>rejected</code>）状态。并且无论是哪种状态都是不可逆的。</p> <p><strong>为什么期约状态不能被<code>JS</code>检测到</strong></p> <p>因为期约状态是私有的，并且其主要是为了<strong>避免</strong>根据<strong>读取到的期约状态</strong>，以<strong>同步</strong>的方式处理期约对象。并且期约的状态也不能够被外部<code>JS</code>代码修改。 <strong>期约故意将异步行为封装起来，从而隔离外部的同步代码。</strong></p> <h3 id="_2-2、解决值、拒绝理由及期约用例"><a href="#_2-2、解决值、拒绝理由及期约用例" class="header-anchor">#</a> 2.2、解决值、拒绝理由及期约用例</h3> <p>p 236</p> <p><strong>期约的两大用途：</strong></p> <ol><li><p>抽象的表示一个异步操作：期约的状态表示期约是否完成。“待定”表示尚未开始或者正在执行中。“兑现”表示已经完成，“拒绝”表示没有成功。</p></li> <li><p>每个期约只要状态切换为<strong>兑现</strong>，就会有一个私有的内部<strong>值</strong>。同样的，当期约状态切换为<strong>拒绝</strong>,就会有一个私有的内部<strong>理由</strong>。无论是值还是理由，都包含原始值或对象不可修改的引用。二者是可选的，默认值都为<code>undefined</code>。在期约达到某个落定状态时执行的异步代码会始终收到这个值或理由。</p></li></ol> <p>某些情况下，<strong>状态机</strong>就是期约可以提供的最有用的信息。例如：通过期约向服务器发送<code>HTTP</code>请求，则可以根据返回的状态码将期约的状态，变为<strong>兑现</strong>或者<strong>拒绝</strong></p> <h3 id="_2-3、通过执行函数控制期约的状态"><a href="#_2-3、通过执行函数控制期约的状态" class="header-anchor">#</a> 2.3、通过执行函数控制期约的状态</h3> <p><strong>为什么要通过执行函数控制期约的状态？</strong></p> <p>以为期约的状态是<strong>私有的</strong>，所以只能在内部进行操作，而内部操作是在期约的执行函数中完成的。</p> <p>执行函数的两项职责：</p> <ol><li><p>初始化期约的异步行为；</p></li> <li><p>控制状态的最终转换；</p></li></ol> <p>控制期约的状态转换通常是通过两个函数参数实现的。通常命名为<code>resolve()</code>和<code>rejected()</code>。调用<code>resolved()</code>会将状态切换为<strong>兑现</strong>，调用<code>rejected()</code>会将状态切换为<strong>拒绝</strong>，并抛出错误。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> rejected</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>rejected</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">rejected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//Uncaught (in promise) undefined</span>
<span class="token comment">//Promise{&lt;rejected&gt;: undefined}</span>
</code></pre></div><p>执行器函数时<strong>同步</strong>执行的。因为执行器函数是期约的初始化程序</p> <p><strong>Promise 执行顺序</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 期约是同步执行的 可以观察到其执行顺序</span>
<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'executor'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token string">'promise'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// executor</span>
<span class="token comment">// promise</span>
</code></pre></div><h3 id="_2-4、-promise-resolve"><a href="#_2-4、-promise-resolve" class="header-anchor">#</a> 2.4、 Promise.resolve()</h3> <p>p 327</p> <p>期约并不是一开始就是待定状态。是可以通过调用静态方法<code>Promise.resolve()</code>，可以实例化一个解决的期约。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>解决的期约的值对应传<code>Promise.resolve()</code>的第一个参数。该方法可以将任何值转换为一个期约。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过 Promise.resolve() 将任何值转换为一个期约</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: 3}</span>
<span class="token comment">// 多余的参数会被忽略</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: 4}</span>
</code></pre></div><p><mark>如果传入的参数本身是个期约，其类似于一个空包装。可将<code>Promise.resolve</code>当做幂等方法</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 使用 Promise.resolve时， 如果传入的是期约， 其就相当于一个空包装</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// true</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// true</span>
</code></pre></div><p><mark>幂等性会保留传入期约的状态</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 同时 幂等性会保留传入期约的状态  期约中需要传入执行器函数 应付解释器</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p <span class="token operator">===</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// true</span>
</code></pre></div><p><code>Promise.resolve()</code>能包装任何非期约值，包括<strong>错误对象</strong>，将其转换为解决的期约。因此可能会出现不和预期的行为。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过 Promise.resolve() 将错误对象 包装成已解决</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: Error: foo</span>
</code></pre></div><h3 id="_2-5、-promise-reject"><a href="#_2-5、-promise-reject" class="header-anchor">#</a> 2.5、 Promise.reject();</h3> <p>p 328</p> <p><code>Promise.reject()</code>能实例化一个<strong>拒绝的期约</strong>并抛出<strong>异步错误</strong>（这个错误不能通过<code>try/catch</code> 捕获，只能够通过拒绝处理程序捕获。）</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 两者相等</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1 <span class="token operator">===</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// true</span>
</code></pre></div><p>和<code>Promise.resolve()</code>一样，<strong>拒绝的期约的理由</strong>会传给<code>Promise.reject()</code>的第一个参数。并且会传给后续的拒绝处理程序。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 拒绝期约的理由作为 promise.reject的第一个参数</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise {&lt;rejected&gt;: 3}</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 3</span>
</code></pre></div><p>同时<code>Promise.reject</code>并没有照搬<code>Promise.resolve()</code>的幂等逻辑。给它传入一个期约对象，<mark>这个期约会成为它返回的拒绝期约的理由</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise {&lt;rejected&gt;: Promise}</span>
</code></pre></div><h3 id="_2-6、同步-异步执行的二元性"><a href="#_2-6、同步-异步执行的二元性" class="header-anchor">#</a> 2.6、同步/异步执行的二元性</h3> <p>p 329</p> <p><mark><code>Promise</code>的<strong>设计</strong>很大程度会导致完全<strong>不同于</strong><code>JS</code>的<strong>计算模式</strong>。</mark></p> <p>下面是两种抛出错误的情形；</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// js 中两种抛出错误的场景</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Error: sans</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'e'</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Uncaught (in promise) Error: bar</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
    Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'e'</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// Uncaught (in promise) foo</span>
</code></pre></div><p>第一个<code>try/catch</code>抛出并捕获了错误，第二个<code>try/catch</code>抛出错误却<strong>没有</strong>捕获到。</p> <p>这个同步代码之所以没有抛出错误，是因为它没有通过<strong>异步模式</strong>捕获错误。</p> <p><strong>什么是期约真正的异步特性？</strong></p> <p>期约是同步对象（在同步执行模式中使用），但也是<strong>异步执行</strong>模式的媒介</p> <p>拒绝期约的<strong>错误</strong>并<strong>没有</strong>抛到<strong>执行同步代码</strong>的<strong>线程</strong>中，而是通过<strong>浏览器异步消息队列</strong>来处理的。代码一旦开始<strong>异步模式执行</strong>，与之<strong>交互</strong>的<strong>唯一方法</strong>就是使用<strong>异步结构</strong>，更具体来说就是-<strong>期约的方法</strong></p> <h2 id="_3、期约的实例方法"><a href="#_3、期约的实例方法" class="header-anchor">#</a> 3、期约的实例方法</h2> <p>期约的实例方法是<strong>连接外部同步代码</strong>和<strong>内部异步代码</strong>之间的桥梁。</p> <p>这些方法可以<strong>访问</strong>异步操作<strong>返回</strong>的<strong>数据、处理期约成功和失败的结果，连续对期约求值，或者添加只有期约进入终止状态时才会执行的代码。</strong></p> <h3 id="_3-1、实现thenable-接口"><a href="#_3-1、实现thenable-接口" class="header-anchor">#</a> 3.1、实现<code>Thenable</code> 接口</h3> <p>在<code>ES</code>暴露的任何<strong>异步结构</strong>中，任何代码都有<code>then()</code>方法。这个方法实现了<code>Thenable</code>接口。</p> <p>实现该接口最简单的类：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">MyThenable</span><span class="token punctuation">{</span>
    <span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-2、-promise-prototype-then"><a href="#_3-2、-promise-prototype-then" class="header-anchor">#</a> 3.2、 <code>Promise.prototype.then()</code></h3> <p><code>Promise.prototype.then()</code>是为<strong>期约实例</strong>添加<strong>处理程序</strong>的<strong>主要方法</strong>；</p> <p><code>then()</code>接受两个参数：<code>onResolved</code>处理程序和<code>onRejected</code>处理程序，并且这两个参数时可选的 。提供的话，期约会分别进入“兑现”和“拒绝”状态时执行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Promise.prototype.then() 传入两个参数  onResolved  和 onRejected</span>
<span class="token keyword">function</span> <span class="token function">onResolved</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">'resolved'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>reject<span class="token punctuation">,</span> <span class="token number">30000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">onResolved</span><span class="token punctuation">(</span><span class="token string">'p1'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token string">'p1'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">onResolved</span><span class="token punctuation">(</span><span class="token string">'p2'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token string">'p2'</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">// p1 resolved</span>
<span class="token comment">// p2 rejected</span>
</code></pre></div><p>期约的只能最终转换状态一次，所以这两个操作一定是互斥的。</p> <p><mark>传给<code>then()</code>的任何非函数类型的参数都会被忽略掉</mark></p> <p><mark>如果只提供<code>onRejected</code>参数，就要在<code>onRevolved</code>参数位置上传入<code>undefined</code></mark></p> <p>这样做能避免在内存中创建多余的对象。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 只给onRejected进行传参</span>
<span class="token keyword">function</span> <span class="token function">onResolved</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">'resolved'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>reject<span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 非函数处理程序会被忽略掉 // 不推荐</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span>

<span class="token comment">// ！！！！ 不传 onResolved 处理程序的规范写法</span>
p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token string">'p2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// p2 rejected  3秒后</span>
</code></pre></div><p><code>Promise.prototype.then()</code>方法会返回一个新的期约实例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Promise.prototype.then() 会返回一个新的期约实例</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p1 <span class="token operator">===</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// false</span>
</code></pre></div><p>该处理程序的返回值会通过<code>Promise.resolve()</code>包装来生成新期约。如果没有提供处理程序，则<code>Promise.resovle()</code>就会包装上一个期约解决后的值。如果没有显示的返回语句，则<code>Promise.resovl()</code>会包装默认的返回值<code>undefined</code>。</p> <p><mark>如果<code>then()</code>中没有处理程序，<code>Promise.resolve</code>就会返回上一个期约的解决值。</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 若调用then() 时不传处理程序， 则原样后传 =&gt; 相当于返回上一个期约的解决值</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise{&lt;fulfilled&gt;: &quot;sans&quot;}</span>
<span class="token keyword">let</span> p3 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p4 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p5 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p6 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p7 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'p3'</span><span class="token punctuation">,</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  p3 Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'p4'</span><span class="token punctuation">,</span>p4<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  p4 Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'p5'</span><span class="token punctuation">,</span>p5<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  p5 Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'p6'</span><span class="token punctuation">,</span>p6<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  p6 Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'p7'</span><span class="token punctuation">,</span>p7<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  p7 Promise {&lt;fulfilled&gt;: &quot;sans&quot;}</span>
</code></pre></div><p>如果没有显示返回语句，则<code>Promise.resolve()</code>会包装默认返回的值<code>undefined</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 若调用then() 时不传处理程序， 则原样后传 =&gt; 相当于返回上一个期约的解决值</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p3 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p4 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p5 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p6 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p7 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'p3'</span><span class="token punctuation">,</span>p3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  p3 Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'p4'</span><span class="token punctuation">,</span>p4<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  p4 Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'p5'</span><span class="token punctuation">,</span>p5<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  p5 Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'p6'</span><span class="token punctuation">,</span>p6<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  p6 Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'p7'</span><span class="token punctuation">,</span>p7<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//  p7 Promise {&lt;fulfilled&gt;: &quot;sans&quot;}</span>
</code></pre></div><p><mark>如果有显示的返回值，则<code>Promise.revolve()会包装这个值。</code></mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 如果有显示的返回值 则Promise.resolve 会包装这个值</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p3 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token comment">// Promise {&lt;fulfilled&gt;: &quot;bar&quot;}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p3<span class="token punctuation">)</span> <span class="token comment">// Promise {&lt;fulfilled&gt;: &quot;bar&quot;}</span>
</code></pre></div><p><mark><code>Promise.resolve()</code>会保留返回的期约</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Promise.resolve 会保留返回的期约</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p4 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p5 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p4<span class="token punctuation">)</span> <span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p5<span class="token punctuation">)</span> <span class="token comment">// Promise {&lt;rejected&gt;: undefined}</span>
</code></pre></div><p><mark>抛出异常会返回拒绝的期约</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 抛出异常会返回拒绝的期约</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token string">'baz'</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//  Uncaught (in promise) baz</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token comment">// Promise {&lt;rejected&gt;: &quot;baz&quot;}</span>
</code></pre></div><p>返回错误的值<strong>不会触发</strong>上面的<strong>拒绝行为</strong>，而是把<strong>错误对象</strong>包装在一个<strong>解决的期约中</strong>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 返回错误值不会触发拒绝行为，而是将错误对象包装在解决的期约中</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'qux'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> p2<span class="token punctuation">)</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: Error: qux</span>
</code></pre></div><p><code>onRejected</code>处理程序的返回值也会被<code>Promise.resolve()</code>包装。</p> <p>因为<code>onRejected</code>处理程序的任务本身就是<strong>捕获异步错误</strong>，所以拒绝处理程序在捕获<strong>异步错误</strong>后不抛出异常是符合期约的行为，应该返回一个<strong>解决期约</strong></p> <p><code>Promise.reject</code> 代替<code>Promise.resovle</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * 使用 Promise.reject 代替 Promise.resolve
 */</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果then() 中不写入处理程序 会原样后传 实际上就是返回上一个期约的解决值</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Uncaught (in promise) sans</span>
<span class="token comment">// Promise {&lt;rejected&gt;: &quot;sans&quot;}</span>
<span class="token comment">// 因为是获取 onRejected的会结果 需要在 onResolved 参数传入一个 null</span>
<span class="token comment">// 如果没有显示的返回值，就会取默认返回值undefined</span>
<span class="token keyword">let</span> p3 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p4 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p5 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p4<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p5<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: undefined}</span>

<span class="token comment">// 有显示的返回值就包装这个值</span>
<span class="token keyword">let</span> p6 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p7 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p6<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p7<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// // Promise {&lt;fulfilled&gt;: &quot;bar&quot;}</span>
<span class="token comment">// // Promise {&lt;fulfilled&gt;: &quot;sans&quot;}</span>

<span class="token comment">// Promise.reject 保留返回的期约</span>
<span class="token keyword">let</span> p8 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p9 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    p10 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p8<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p9<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p10<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: undefined}</span>
<span class="token comment">// Promise {&lt;rejected&gt;: undefined}</span>

<span class="token comment">// 抛出异常会返回拒绝的期约</span>
<span class="token keyword">let</span> p11 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">throw</span> <span class="token string">'sans'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Uncaught (in promise) baz</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p11<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise {&lt;rejected&gt;: &quot;sans&quot;}</span>

<span class="token comment">// 抛出错误不会触发拒绝行为， 而是将错误对象包装到一个解决的期约中</span>
<span class="token keyword">let</span> p12 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p12<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: Error: sans</span>
</code></pre></div><h3 id="_3-3、promise-prototype-catch"><a href="#_3-3、promise-prototype-catch" class="header-anchor">#</a> 3.3、<code>Promise.prototype.catch()</code></h3> <p>p 332</p> <p><code>Promise.prototype.catch()</code>方法用于给期约添加<strong>拒绝处理程序</strong>。只接受<code>onRejected</code>处理程序。</p> <p>本质上，该方法是一个<strong>语法糖</strong>，调用它相当于调用<code>Promise.prototype.then((null,onRejected))</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">onRejected</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token string">'rejected'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 这两种添加拒绝处理程序的方式是一样的</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>onRejected<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// rejected</span>
p<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span>onRejected<span class="token punctuation">)</span>   <span class="token comment">// rejected</span>
</code></pre></div><p><code>Promise.prototype.catch()</code>返回的是一个<strong>新的期约实例</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> p1<span class="token punctuation">)</span> <span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> p1 <span class="token operator">===</span> p2<span class="token punctuation">)</span> <span class="token comment">// false</span>
</code></pre></div><p>在返回新期约实例方面<code>Promise.prototype.catch()</code>行为与<code>Promise.prototype.then()</code>的<code>onRejected</code>处理程序是一样的。</p> <h3 id="_3-4、promise-prototype-finally"><a href="#_3-4、promise-prototype-finally" class="header-anchor">#</a> 3.4、<code>Promise.prototype.finally()</code></h3> <p>p 333</p> <p><code>Promise.prototype.finally()</code>用于给期约添加<code>onFinally</code>处理程序。这个程序在期约转换为解决或拒绝状态时都会执行。能够避免<code>onResolved</code>和<code>onRejected</code>出现冗余的代码。</p> <p>该方法不知道期约的状态，因此主要是用来清理代码。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Promise.prototype.finally() 用于清理冗余代码</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token function-variable function">onFinally</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'Finally!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span>onFinally<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// finally</span>
p2<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span>onFinally<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// finally</span>
</code></pre></div><p>和其他几个实例方法一样，<code>Promise.prototype.finally</code>返回一个新的期约实例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> p1<span class="token punctuation">)</span> <span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> p2<span class="token punctuation">)</span> <span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> p1 <span class="token operator">===</span> p2<span class="token punctuation">)</span> <span class="token comment">// false*/</span>
</code></pre></div><p><code>onFinally</code>被设计为一个与状态无关的方法，因此大多数情况下都表示为<strong>父期约的传递</strong></p> <p>可以理解为不管传递什么期约，返回去的实例是该期约</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 该期约返回的实例，大多数情况下都表示父期约的传递</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 都是原样后传</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p3 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p4 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p5 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p6 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p7 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p8 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'qux'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;resolved&gt;: sans</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;resolved&gt;: sans</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p4<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;resolved&gt;: sans</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p5<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;resolved&gt;: sans</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p6<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;resolved&gt;: sans</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p7<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;resolved&gt;: sans</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p8<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;resolved&gt;: sans</span>
</code></pre></div><p>如果返回一个<strong>待定</strong>的期约，或者<code>onFinally</code>处理程序出现了错误（显示的抛出或返回一个拒绝期约），则会返回相应的期约。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 如果返回一个待定的期约 或者显示的抛出或者返回一个错误期约</span>
<span class="token comment">// 会返回待定和拒绝的状态</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> p3 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'rejected'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// Uncaught (in promise): undefined</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//</span>
<span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token comment">// Promise {&lt;rejected&gt;: &quot;rejected&quot;}</span>
<span class="token keyword">let</span> p4 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token string">'baz'</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Uncaught (in promise) baz</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p4<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;rejected&gt;: baz</span>
</code></pre></div><p><strong>返回待定期约</strong>的情形并不常见，因为只要期约一解决，新期约仍然会原样后传初始期约。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 该期约还未被解决</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token comment">// 该期约已被解决 返回初始化期约</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 200ms 后  Promise &lt;resolved&gt; : 'sans'</span>
</code></pre></div><h3 id="_3-5、非重入期约方法"><a href="#_3-5、非重入期约方法" class="header-anchor">#</a> 3.5、非重入期约方法</h3> <p>p334</p> <p>当期约进入落定状态时，与期约状态相关的<strong>处理程序</strong>只会被排期，而非立即执行。<strong>跟在</strong>添加这个处理代码之后的<strong>同步代码</strong>，一定会在<strong>处理程序前</strong>执行。即使期约一开始就与附加处理程序关联的状态，执行顺序也是这样。</p> <p><mark>该特性由<code>JS</code>运行时保证，被称为<strong>非重入</strong>特性</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 非重入特性</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'then() return'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// then() return</span>
<span class="token comment">// sans</span>
</code></pre></div><p>先添加处理程序后解决期约也是一样的。如果添加处理程序后，同步代码才改变期约状态，那么处理程序仍然会基于该状态变化表现出非重入特性。</p> <p>下面例子展示即使先添加<code>onResolved</code>处理程序，再同步调用<code>resolve()</code>，处理程序也不会进入同步线程。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> syncResolve<span class="token punctuation">;</span>
<span class="token comment">// 创建一个期约并将解决函数保存到一个局部变量中</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">syncResolve</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'1: invoking resolve()'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'2: resolve() returns'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 此处 then 调用的实际上是 resolve 回调</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4:  then() handler executes'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token function">syncResolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3: syncResolve() returns'</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> syncResolve<span class="token punctuation">;</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 此处 then 调用的实际上是 resolve 回调</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'4:  then() handler executes'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// syncResolve();</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'3: syncResolve() returns'</span><span class="token punctuation">)</span>

<span class="token comment">//  4:  then() handler executes</span>
<span class="token comment">//  3: syncResolve() returns</span>
</code></pre></div><p>即使期约状态变化发生在添加期约处理程序后，处理程序也会等到运行的消息队列让他出列时才执行。</p> <p>非重入适用于 onResolved/onRejected 处理程序、catch()处理程序和 finally()处理程序。
下面的例子演示了这些处理程序都只能异步执行：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1.then() onResolved'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1.then() returns'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">let</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2.then() onRejected'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2.then() returns'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">let</span> p3 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
p3<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p3.catch() onRejected'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p3.catch() returns'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">let</span> p4 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
p4<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p4.finally() onFinally'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p4.finally() returns'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// p1.then() returns </span>
<span class="token comment">// p2.then() returns </span>
<span class="token comment">// p3.catch() returns </span>
<span class="token comment">// p4.finally() returns </span>
<span class="token comment">// p1.then() onResolved </span>
<span class="token comment">// p2.then() onRejected </span>
<span class="token comment">// p3.catch() onRejected </span>
<span class="token comment">// p4.finally() onFinally </span>
</code></pre></div><h3 id="_3-6、临近处理程序的执行顺序"><a href="#_3-6、临近处理程序的执行顺序" class="header-anchor">#</a> 3.6、临近处理程序的执行顺序</h3> <p>当期约状态变化时，相关处理程序会按照添加他们的顺序依次执行。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 期约发生变化时，相关处理程序会按照添加顺序依次执行</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 1</span>
<span class="token comment">// 2</span>
p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3</span>
<span class="token comment">// 4</span>
p2<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p2<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 5</span>
<span class="token comment">// 6</span>
p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p1<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// 7</span>
<span class="token comment">// 8</span>
</code></pre></div><h3 id="_3-7、传递解决值和拒绝期约"><a href="#_3-7、传递解决值和拒绝期约" class="header-anchor">#</a> 3.7、传递解决值和拒绝期约</h3> <p>期约状态落定后，会提供解决值或拒绝理由给相关的处理程序。</p> <p>在执行函数中，<strong>解决的值</strong>和<strong>拒绝的理由</strong>分别作为<code>resolve</code>和<code>reject</code>的第一个参数往后传递。再将这些值传给他们各自的处理程序。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 传递解决值和拒绝的理由</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// sans</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resovle<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'hw'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
p2<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token comment">// hw</span>
</code></pre></div><p><code>Promise.resolve()</code>和<code>Promise.reject()</code>在调用时就会接受解决值和拒绝理由。同样的他们返回的期约会像执行器一样传递给相应的处理程序</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过 promise.resolve 和 promise.reject 传递解决值或拒绝理由</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// sans</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'hw'</span><span class="token punctuation">)</span>
p2<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">reason</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// hw</span>
</code></pre></div><h3 id="_3-8、拒绝期约与拒绝报错处理"><a href="#_3-8、拒绝期约与拒绝报错处理" class="header-anchor">#</a> 3.8、拒绝期约与拒绝报错处理</h3> <p>拒绝期约类似于<code>throw()</code>表达式，都表示一种<strong>程序状态</strong>，即需要中断或者特殊处理。</p> <p>在期约的执行函数或者处理程序中<strong>抛出错误</strong>会导致拒绝，对应的错误对象会成为拒绝的理由。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 在执行函数或处理程序中抛出错误会导致拒绝，对应的对象会成为拒绝的理由</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> p3 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> p4 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 错误导致拒绝</span>
<span class="token keyword">let</span> p5 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>  <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;rejected&gt;: Error: sans</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;rejected&gt;: Error: sans</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p3<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;rejected&gt;: Error: sans</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p4<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;rejected&gt;: Error: sans</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p5<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise {&lt;fulfilled&gt;: undefined}</span>
</code></pre></div><p>同时也抛出了4个错误的<strong>栈追踪对象</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">Uncaught</span> <span class="token punctuation">(</span><span class="token keyword">in</span> promise<span class="token punctuation">)</span> Error<span class="token operator">:</span> foo 
 at <span class="token function">Promise</span> <span class="token punctuation">(</span>test<span class="token punctuation">.</span>html<span class="token operator">:</span><span class="token number">5</span><span class="token punctuation">)</span> 
 at <span class="token keyword">new</span> <span class="token class-name">Promise</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span><span class="token punctuation">)</span> 
 at test<span class="token punctuation">.</span>html<span class="token operator">:</span><span class="token number">5</span> 
<span class="token function">Uncaught</span> <span class="token punctuation">(</span><span class="token keyword">in</span> promise<span class="token punctuation">)</span> Error<span class="token operator">:</span> foo 
 at <span class="token function">Promise</span> <span class="token punctuation">(</span>test<span class="token punctuation">.</span>html<span class="token operator">:</span><span class="token number">6</span><span class="token punctuation">)</span> 
 at <span class="token keyword">new</span> <span class="token class-name">Promise</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>anonymous<span class="token operator">&gt;</span><span class="token punctuation">)</span> 
 at test<span class="token punctuation">.</span>html<span class="token operator">:</span><span class="token number">6</span> 
<span class="token function">Uncaught</span> <span class="token punctuation">(</span><span class="token keyword">in</span> promise<span class="token punctuation">)</span> Error<span class="token operator">:</span> foo 
 at test<span class="token punctuation">.</span>html<span class="token operator">:</span><span class="token number">8</span> 
<span class="token function">Uncaught</span> <span class="token punctuation">(</span><span class="token keyword">in</span> promise<span class="token punctuation">)</span> Error<span class="token operator">:</span> foo 
 at Promise<span class="token punctuation">.</span>resolve<span class="token punctuation">.</span><span class="token function">then</span> <span class="token punctuation">(</span>test<span class="token punctuation">.</span>html<span class="token operator">:</span><span class="token number">7</span><span class="token punctuation">)</span> 
</code></pre></div><p>所有错误都是<strong>异步抛出</strong>且未处理的，通过错误对象捕获的<strong>栈追踪</strong>信息展示了错误发生的路径。</p> <p>其中<code>Promise.resovle.then()</code>的错误最后才出现，因为其需要在<strong>运行时消息队列</strong>中<strong>添加</strong>处理程序；也就是说，在最终<strong>抛出未捕获错误</strong>之前还会创建另一个期约</p> <p><mark>异步错误的副作用</mark></p> <p>正常情况下，通过<code>throw()</code>关键字抛出错误时，<code>JS</code>运行时的<strong>错误处理机制</strong>会<strong>停止</strong>执行抛出错误之后的任何命令。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 异步错误的副作用 通过throw()关键字抛出的错误，通常情况下</span>
<span class="token comment">// JS运行时的错误处理机制不会执行抛出错误后的任何指令</span>
<span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 不会执行这一行</span>
<span class="token comment">// Uncaught Error: sans</span>
</code></pre></div><p>但在期约中抛出错误时，错误实际上是在<strong>消息队列</strong>中异步抛出的，所以并不会<strong>阻止</strong>运行时继续执行<strong>同步命令</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 期约抛出错误时，是在消息队列中异步抛出的 并不会阻止运行时继续执行同步代码</span>
Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// bar</span>
<span class="token comment">// Uncaught Error: sans</span>
</code></pre></div><p><mark>异步错误只能够通过<strong>异步</strong>的<code>onReject</code>处理程序捕获</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 正确</span>
Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 错误</span>
<span class="token keyword">try</span><span class="token punctuation">{</span>
    Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    
<span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
</code></pre></div><p><mark>执行函数中的错误，在解决或拒绝期约之前，仍然可以使用<code>try/catch</code>捕获</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//执行器函数中的错误 在期约解决或拒绝之前，仍然可以使用 try/catch 进行错误捕获</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'foo'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Error: foo</span>
    <span class="token punctuation">}</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>  <span class="token comment">// Promise {&lt;fulfilled&gt;: &quot;sans&quot;}</span>
</code></pre></div><p><code>then()</code>和<code>catch()</code>的<code>onReject</code>处理程序在语义上相当于<code>try/catch</code>。都是捕获错误之后他将其隔离，不影响正常逻辑的执行。</p> <p>因此，<code>onReject</code>处理程序的任务是在捕获异步错误之后返回一个<strong>解决</strong>的期约。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// then() 和 catch()在语义上类似于 try/catch 都是捕获错误然后进行隔离，且不影响正常逻辑</span>
<span class="token comment">// 因此 onReject 处理程序的任务是捕获异步错误之后返回一个解决的期约</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'begin sync execution'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'caught error'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'continue sync execution'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// begin sync execution</span>
<span class="token comment">// caught error Error: sans</span>
<span class="token comment">// continue sync execution</span>

<span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'begin sync execution'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token string">'sans'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'caught error'</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'continue asynchronous execution'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// begin sync execution</span>
<span class="token comment">// caught error Error: sans</span>
<span class="token comment">// continue sync execution</span>
</code></pre></div><h2 id="_4、期约连锁和期约合成"><a href="#_4、期约连锁和期约合成" class="header-anchor">#</a> 4、期约连锁和期约合成</h2> <p>p338</p> <p><strong>怎样将多个期约组合在一起？</strong></p> <p>期约组合有两种方式实现：<strong>期约连锁</strong>和<strong>期约合成</strong>。</p> <ul><li><p>期约连锁：期约一个接一个进行拼接；</p></li> <li><p>期约合成：将多个期约组合为一个期约；</p></li></ul> <h3 id="_4-1、期约连锁"><a href="#_4-1、期约连锁" class="header-anchor">#</a> 4.1、期约连锁</h3> <p>p338</p> <p><strong>什么是期约连锁？</strong></p> <p>将每个期约串联起来的编程方式，并且每个<strong>期约实例</strong>方法（<code>then()、catch()和finally()</code>）都会返回一个<strong>新的</strong>期约对象。而该新期约又有自己的<strong>实例方法</strong>。这种连缀方法调用就可以构成所谓的<strong>期约连锁</strong></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'first'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'second'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'third'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'fourth'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// first</span>
<span class="token comment">// second</span>
<span class="token comment">// third</span>
<span class="token comment">// fourth</span>
</code></pre></div><p>这个实现最终执行了一连串<strong>同步</strong>任务</p> <p>真正执行<strong>异步</strong>任务，需要每个执行器都返回一个期约实例。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p1 executor'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p2 executor'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve <span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p3 executor'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'p4 executor'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token comment">// p1 executor（1 秒后）</span>
<span class="token comment">// p2 executor（2 秒后）</span>
<span class="token comment">// p3 executor（3 秒后）</span>
<span class="token comment">// p4 executor（4 秒后）</span>
</code></pre></div><p>通过工厂函数生成</p> <p>要记住 <code>then</code>中的方法是要在期约状态转换为<strong>解决或拒绝</strong>时执行</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 将期约生成的代码提取到工厂函数中</span>
<span class="token keyword">function</span> <span class="token function">delayedResolve</span><span class="token punctuation">(</span><span class="token parameter">str</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">delayedResolve</span><span class="token punctuation">(</span><span class="token string">'p1 executor'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">delayedResolve</span><span class="token punctuation">(</span><span class="token string">'p2 executor'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">delayedResolve</span><span class="token punctuation">(</span><span class="token string">'p3 executor'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">delayedResolve</span><span class="token punctuation">(</span><span class="token string">'p4 executor'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// p1 executor（1 秒后）</span>
<span class="token comment">// p2 executor（2 秒后）</span>
<span class="token comment">// p3 executor（3 秒后）</span>
<span class="token comment">// p4 executor（4 秒后）</span>
</code></pre></div><p>不使用期约的写法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 不使用期约的写法</span>
<span class="token keyword">function</span> <span class="token function">delayedExecute</span><span class="token punctuation">(</span><span class="token parameter">str<span class="token punctuation">,</span>callback <span class="token operator">=</span> <span class="token keyword">null</span></span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        callback <span class="token operator">&amp;&amp;</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">delayedExecute</span><span class="token punctuation">(</span><span class="token string">'p1 callback'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">delayedExecute</span><span class="token punctuation">(</span><span class="token string">'p2 callback'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">delayedExecute</span><span class="token punctuation">(</span><span class="token string">'p3 callback'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">delayedExecute</span><span class="token punctuation">(</span><span class="token string">'p4 callback'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// p1 callback（1 秒后）</span>
<span class="token comment">// p2 callback（2 秒后）</span>
<span class="token comment">// p3 callback（3 秒后）</span>
<span class="token comment">// p4 callback（4 秒后）</span>
</code></pre></div><p><code>then(),catch(),finally</code>都会返回新的期约</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// then() catch() finally() 都会返回新的期约</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'initial promise rejects'</span><span class="token punctuation">)</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'reject handler'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'resolve handler'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'finally handler'</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> 
</code></pre></div><h3 id="_4-2、期约图"><a href="#_4-2、期约图" class="header-anchor">#</a> 4.2、期约图</h3> <p>p 340</p> <p>因为一个期约可以有多个处理程序，所以期约连锁可以<strong>构建</strong> <strong>有向非循环图</strong>的结构。每个期约都是图中的一个节点，使用实例方法添加的处理程序则是<strong>有向顶点</strong>。因为图中的每个节点都会等待前一个节点的落定，所以图的方向就是期约的解决或拒绝顺序</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token constant">A</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'A'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> <span class="token constant">B</span> <span class="token operator">=</span> <span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'B'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> <span class="token constant">C</span> <span class="token operator">=</span> <span class="token constant">A</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'C'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token constant">B</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'D'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token constant">B</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'E'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token constant">C</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'F'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token constant">C</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'G'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// A</span>
<span class="token comment">// B</span>
<span class="token comment">// C</span>
<span class="token comment">// D</span>
<span class="token comment">// E</span>
<span class="token comment">// F</span>
<span class="token comment">// G</span>
</code></pre></div><p>期约的处理程是<strong>先添加到消息队列中</strong>，然后再<strong>逐个</strong>执行，因此构成了层序遍历。</p> <p>树只是期约图的一种形式，<strong>有向非循环图</strong>是体现期约连锁可能性的最准确体现。</p> <h3 id="_4-3、promise-all-和-promise-race"><a href="#_4-3、promise-all-和-promise-race" class="header-anchor">#</a> 4.3、Promise.all()和 Promise.race()</h3> <p>p 341</p> <p><code>Promise</code>类提供了<strong>两个</strong>将<strong>多个期约实例组合</strong>在一起的静态方法：<code>Promise.all()</code>和<code>Promise.race()</code>。合成后期约的行为取决于内部期约的行为</p> <h4 id="_4-3-1、promise-all"><a href="#_4-3-1、promise-all" class="header-anchor">#</a> 4.3.1、Promise.all()</h4> <p><code>Promise.all()</code>静态方法创建的期约会在一组期约<strong>全部解决之后</strong>再解决。该方法接受的是一个迭代对象，返回一个新期约。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Promise.all()静态方法创建的期约会在一组期约全部解决后再解决，接受的是可迭代数组</span>
<span class="token comment">// ，返回一个新期约</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 可迭代对象中的元素会通过Promise.resolve()转换为期约</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 空的可迭代对象等价于 Promise.resolve()</span>
<span class="token keyword">let</span> p3 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 无效的语法</span>
<span class="token keyword">let</span> p4 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><mark>合成的期约只会在每个期约解决后才解决</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 合成期约只有在所有期约都完成后才解决</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token comment">// Promise {&lt;pending&gt;}</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> <span class="token string">'all resolved'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">// all resolved 1s 后</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span><span class="token number">1500</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: Array(2)} 1.5s 后</span>
</code></pre></div><p><mark>如果包含包含一个期约待定，则合成期约也会待定</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 包含一个期约待定，则合成期约也是待定</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Promise &lt;pending&gt; </span>
</code></pre></div><p><mark>如果包含一个期约拒绝，则合成期约也会拒绝</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 如果包含一个期约拒绝，则合成期约也会拒绝</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span> 
<span class="token comment">// setTimeout中的方法是存放在消息队列中的，需要执行栈执行完成才会运行</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span>
<span class="token comment">// Promise {&lt;rejected&gt;: undefined}</span>
<span class="token comment">// // Uncaught (in promise) undefined</span>
</code></pre></div><p><mark>所有期约都解决，则合成的期约解决值是包含所有期约解决值的数组，按照迭代器顺序</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 所有期约都解决，则合成期约的解决值就是所有期约解决值得数组</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// [2, undefined, 3]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>如果含有拒绝期约，则第一个拒绝期约会将<strong>自己的理由</strong>作为合成期约的理由。之后再拒绝的期约不会影响最终期约的拒绝理由。<mark>合成期约会静默的处理所有包含期约的拒绝操作</mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 如果有拒绝的期约，则第一拒绝期约的理由会成为合成期约的理由，并且后续的拒绝期约</span>
<span class="token comment">// 不会影响到最终期约的拒绝理由。合成期约会静默的处理所有包含期约的拒绝操作</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span>reject<span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
</code></pre></div><h4 id="_4-3-2、promise-race"><a href="#_4-3-2、promise-race" class="header-anchor">#</a> 4.3.2、Promise.race()</h4> <p>p 343</p> <p><code>Promise.race()</code>静态方法返回一个<strong>包装期约</strong>，是一组集合中<strong>最先解决或拒绝</strong>的期约的镜像。这个方法接受一个<strong>可迭代对象</strong>，返回一个新期约。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment">// 可迭代对象中的元素会通过 Promise.resolve转换为 期约</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span><span class="token string">'p2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>

<span class="token comment">// 空的可迭代对象 等价于 new Promise(()=&gt; {})</span>
<span class="token keyword">let</span> p3 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> p3<span class="token punctuation">)</span>
<span class="token comment">// Promise {&lt;pending&gt;}</span>
<span class="token comment">// 无效的语法</span>
<span class="token keyword">let</span> p4 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// TypeError: cannot read Symbol.iterator of undefined</span>
</code></pre></div><p>无论是解决还是拒绝，只要是<strong>第一个</strong>落定的期约，<code>Promise.race</code>就会<strong>包装其解决值或拒绝的理由</strong>并返回新期约</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 只要是第一个状态落定的期约，Promise.race()就会包装解决值或拒绝理由然后返回新期约</span>
<span class="token comment">// 解决先发生，超时后的拒绝被忽略</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>reject<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span> p1<span class="token punctuation">)</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: 3}</span>
<span class="token comment">// 拒绝先发生，超时后的解决被忽略</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> p2<span class="token punctuation">)</span>
<span class="token comment">// Promise {&lt;rejected&gt;: 4}</span>
<span class="token comment">// 迭代顺序决定落定顺序</span>
<span class="token keyword">let</span> p3 <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span> p3<span class="token punctuation">)</span>
<span class="token comment">// Promise {&lt;fulfilled&gt;: 5}</span>
</code></pre></div><p>与<code>Promise.all</code>一样，合成期约会静默的处理所有包含期约的拒绝操作。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 与Promise.all()一样，合成期约会静默处理所有期约的拒绝操作</span>
<span class="token comment">// 只有第一个拒绝理由会进入拒绝处理程序</span>
<span class="token comment">// 第二个期约的拒绝也会被静默处理，不会有错误跑掉</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">undefined</span><span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>reject<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 1</span>
<span class="token comment">// 1</span>
</code></pre></div><h3 id="_4-4、串行期约合成"><a href="#_4-4、串行期约合成" class="header-anchor">#</a> 4.4、串行期约合成</h3> <p>p 344</p> <p>在这个例子中，有 3 个函数基于一个值合成为一个函数。类似地，期约也可以像这样合成起来，渐进地消费一个值，并返回一个结果：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">addTwo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span> 
<span class="token keyword">function</span> <span class="token function">addThree</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token punctuation">}</span> 
<span class="token keyword">function</span> <span class="token function">addFive</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token punctuation">}</span> 
<span class="token keyword">function</span> <span class="token function">addTen</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
 <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> 
 <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>addTwo<span class="token punctuation">)</span> 
 <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>addThree<span class="token punctuation">)</span> 
 <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>addFive<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token function">addTen</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 18 </span>
</code></pre></div><p>使用<code>Array.prototype.reduce()</code>可以写成更简洁的形式：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">addTwo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span> 
<span class="token keyword">function</span> <span class="token function">addThree</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token punctuation">}</span> 
<span class="token keyword">function</span> <span class="token function">addFive</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token punctuation">}</span> 
<span class="token keyword">function</span> <span class="token function">addTen</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
 <span class="token keyword">return</span> <span class="token punctuation">[</span>addTwo<span class="token punctuation">,</span> addThree<span class="token punctuation">,</span> addFive<span class="token punctuation">]</span> 
 <span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span> 
<span class="token function">addTen</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 18</span>
</code></pre></div><p><mark>提取通用函数，将<strong>任意多个函数</strong>作为<strong>处理程序</strong>合成一个<strong>连续传值的期约连锁</strong></mark></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 提取通用函数 将多个函数作为处理程序合成一个连续传值的期约连锁</span>
<span class="token keyword">function</span> <span class="token function">addTwo</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">addThree</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">addFive</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token keyword">return</span> x <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>fns</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
<span class="token comment">// 通过闭包的特性将参数传入</span>
<span class="token comment">// 初始化数据是一个期约 因此 promise 相当于一个期约</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>  fns<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">,</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">let</span> addTen <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span>addTwo<span class="token punctuation">,</span>addThree<span class="token punctuation">,</span>addFive<span class="token punctuation">)</span>
<span class="token comment">// console.log(addTen);  // (x) =&gt; {}</span>
<span class="token function">addTen</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token comment">// 18</span>
</code></pre></div><h2 id="_5、期约扩展"><a href="#_5、期约扩展" class="header-anchor">#</a> 5、期约扩展</h2> <p>p345</p> <p>期约的不足之处：</p> <p>很多第三方的期约库实现中具备，但是<code>ECMAScript</code>规范中却未涉及的两个特性：<strong>期约取消和进度追踪</strong></p> <h3 id="_5-1-期约取消"><a href="#_5-1-期约取消" class="header-anchor">#</a> 5.1 期约取消</h3> <p>p345</p> <p>可以在现有实现的基础上封装一个临时的实例方法，用以实现取消期约的功能。</p> <p>通过“取消令牌<code>cancel token</code>”。生成的令牌实例提供一个接口，利用该接口可以取消期约；同时也提供了一个期约的实例，可以用来触发取消后的操作并对其求值</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>start<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Start<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span> 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>cancel<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Cancel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">CancelToken</span> <span class="token punctuation">{</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">cancelFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">cancelFn</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span><span class="token string">'delay cancelled'</span><span class="token punctuation">)</span>
                    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> startButton <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#start'</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> cancelButton <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#cancel'</span><span class="token punctuation">)</span>
    <span class="token keyword">function</span> <span class="token function">cancellableDelayedResolved</span><span class="token punctuation">(</span><span class="token parameter">delay</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'set delay'</span><span class="token punctuation">)</span>
<span class="token comment">/*        return new Promise((resolve,reject)=&gt; {
            const id = setTimeout((()=&gt; {
                setTimeout(console.log, 0, 'delay resolve');
                resolve()
            }), delay)
            const cancelToken = new CancelToken((cancelCallBack)=&gt;
                cancelButton.addEventListener('click',cancelCallBack))
            cancelToken.promise.then(()=&gt; clearTimeout(id))
        }) */</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span>reject</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'delay resolve'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> delay<span class="token punctuation">)</span>
            <span class="token keyword">const</span> cancelToken <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CancelToken</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">cancelCallBack</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span>
                cancelButton<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span>cancelCallBack<span class="token punctuation">)</span><span class="token punctuation">)</span>
            cancelToken<span class="token punctuation">.</span>promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    startButton<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;click&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">cancellableDelayedResolved</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><p>每次单击“Start”按钮都会开始计时，并实例化一个新的 CancelToken 的实例。此时，“Cancel”按钮一旦被点击，就会触发令牌实例中的期约解决。而解决之后，单击“Start”按钮设置的超时也会被取消。</p> <h3 id="_5-2、期约进度通知"><a href="#_5-2、期约进度通知" class="header-anchor">#</a> 5.2、期约进度通知</h3> <p>通过扩展实现<code>ES6</code>期约中不支持的进度跟踪</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">TrackablePromise</span> <span class="token keyword">extends</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> notifyHandlers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">status</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            notifyHandlers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">handler</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>notifyHandlers <span class="token operator">=</span> notifyHandlers<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">notify</span><span class="token punctuation">(</span><span class="token parameter">notifyHandler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>notifyHandlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>notifyHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> 
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrackablePromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject<span class="token punctuation">,</span> notify</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">countdown</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">notify</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token number">20</span> <span class="token operator">*</span> x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">% remaining</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">countdown</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">countdown</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'progress:'</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>console<span class="token punctuation">.</span>log<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'completed'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新时间: </span> <span class="time">7/31/2021, 1:32:04 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/js/Promise/" class="prev router-link-active">
            /js/Promise/
          </a></span> <span class="next"><a href="/js/Promise/asyncAwait.html">
            异步函数(async/await)
          </a></span></p></div> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-cb1513f6><li class="level-2" data-v-cb1513f6><a href="/js/Promise/promise.html#期约-promise" class="sidebar-link reco-side-期约-promise" data-v-cb1513f6>期约 (promise)</a></li><li class="level-2" data-v-cb1513f6><a href="/js/Promise/promise.html#_1、promise-a-规范" class="sidebar-link reco-side-_1、promise-a-规范" data-v-cb1513f6>1、Promise/A+规范</a></li><li class="level-2" data-v-cb1513f6><a href="/js/Promise/promise.html#_2、期约基础" class="sidebar-link reco-side-_2、期约基础" data-v-cb1513f6>2、期约基础</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_2-1、期约状态机" class="sidebar-link reco-side-_2-1、期约状态机" data-v-cb1513f6>2.1、期约状态机</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_2-2、解决值、拒绝理由及期约用例" class="sidebar-link reco-side-_2-2、解决值、拒绝理由及期约用例" data-v-cb1513f6>2.2、解决值、拒绝理由及期约用例</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_2-3、通过执行函数控制期约的状态" class="sidebar-link reco-side-_2-3、通过执行函数控制期约的状态" data-v-cb1513f6>2.3、通过执行函数控制期约的状态</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_2-4、-promise-resolve" class="sidebar-link reco-side-_2-4、-promise-resolve" data-v-cb1513f6>2.4、 Promise.resolve()</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_2-5、-promise-reject" class="sidebar-link reco-side-_2-5、-promise-reject" data-v-cb1513f6>2.5、 Promise.reject();</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_2-6、同步-异步执行的二元性" class="sidebar-link reco-side-_2-6、同步-异步执行的二元性" data-v-cb1513f6>2.6、同步/异步执行的二元性</a></li><li class="level-2" data-v-cb1513f6><a href="/js/Promise/promise.html#_3、期约的实例方法" class="sidebar-link reco-side-_3、期约的实例方法" data-v-cb1513f6>3、期约的实例方法</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_3-1、实现thenable-接口" class="sidebar-link reco-side-_3-1、实现thenable-接口" data-v-cb1513f6>3.1、实现Thenable 接口</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_3-2、-promise-prototype-then" class="sidebar-link reco-side-_3-2、-promise-prototype-then" data-v-cb1513f6>3.2、 Promise.prototype.then()</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_3-3、promise-prototype-catch" class="sidebar-link reco-side-_3-3、promise-prototype-catch" data-v-cb1513f6>3.3、Promise.prototype.catch()</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_3-4、promise-prototype-finally" class="sidebar-link reco-side-_3-4、promise-prototype-finally" data-v-cb1513f6>3.4、Promise.prototype.finally()</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_3-5、非重入期约方法" class="sidebar-link reco-side-_3-5、非重入期约方法" data-v-cb1513f6>3.5、非重入期约方法</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_3-6、临近处理程序的执行顺序" class="sidebar-link reco-side-_3-6、临近处理程序的执行顺序" data-v-cb1513f6>3.6、临近处理程序的执行顺序</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_3-7、传递解决值和拒绝期约" class="sidebar-link reco-side-_3-7、传递解决值和拒绝期约" data-v-cb1513f6>3.7、传递解决值和拒绝期约</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_3-8、拒绝期约与拒绝报错处理" class="sidebar-link reco-side-_3-8、拒绝期约与拒绝报错处理" data-v-cb1513f6>3.8、拒绝期约与拒绝报错处理</a></li><li class="level-2" data-v-cb1513f6><a href="/js/Promise/promise.html#_4、期约连锁和期约合成" class="sidebar-link reco-side-_4、期约连锁和期约合成" data-v-cb1513f6>4、期约连锁和期约合成</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_4-1、期约连锁" class="sidebar-link reco-side-_4-1、期约连锁" data-v-cb1513f6>4.1、期约连锁</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_4-2、期约图" class="sidebar-link reco-side-_4-2、期约图" data-v-cb1513f6>4.2、期约图</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_4-3、promise-all-和-promise-race" class="sidebar-link reco-side-_4-3、promise-all-和-promise-race" data-v-cb1513f6>4.3、Promise.all()和 Promise.race()</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_4-4、串行期约合成" class="sidebar-link reco-side-_4-4、串行期约合成" data-v-cb1513f6>4.4、串行期约合成</a></li><li class="level-2" data-v-cb1513f6><a href="/js/Promise/promise.html#_5、期约扩展" class="sidebar-link reco-side-_5、期约扩展" data-v-cb1513f6>5、期约扩展</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_5-1-期约取消" class="sidebar-link reco-side-_5-1-期约取消" data-v-cb1513f6>5.1 期约取消</a></li><li class="level-3" data-v-cb1513f6><a href="/js/Promise/promise.html#_5-2、期约进度通知" class="sidebar-link reco-side-_5-2、期约进度通知" data-v-cb1513f6>5.2、期约进度通知</a></li></ul></main> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.c68e1700.js" defer></script><script src="/assets/js/3.957d5f92.js" defer></script><script src="/assets/js/1.1e92a90c.js" defer></script><script src="/assets/js/34.29b25dcb.js" defer></script>
  </body>
</html>
